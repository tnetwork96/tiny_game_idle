ESP32 Game Flow – Keyboard Implementation

Display: 1.44" TFT (128×128), Pixel Art arcade style. Virtual QWERTY keyboard optimized for 128×128 resolution.

=== KEYBOARD DRAWING METHOD ===

1. TWO-STEP DRAWING PROCESS:
   - Step 1: Draw all key backgrounds first (fillRect for all keys)
   - Step 2: Fill text into keys after (print text on each key)
   - This approach reduces flicker and improves rendering performance

2. KEY SPECIFICATIONS:
   - Key size: 12x12 pixels
   - Spacing between keys: 1 pixel
   - Keyboard position: X=0, Y=80 (starts at 80px from top)
   - Total keyboard layout: 3 rows of 10 keys + 1 Space key row

3. TEXT RENDERING:
   - Text size: Variable (default = 1, can be changed via setTextSize())
   - Text width calculation: ~4px * textSize per character
   - Text positioning:
     * Horizontal margin: 2px from edges to avoid border overlap
     * Vertical position: yPos + 1 (1px from top of key)
     * Text X offset: textX - 1.5 (fine-tuned for better alignment)
   - Text truncation: If text length > 1, only show first 2 characters
   - Text centering: Automatically centered if text fits within key width

4. COLOR SYSTEM (All customizable via setter methods):
   - keyBgColor: Normal key background (default: TFT_WHITE)
   - keySelectedColor: Selected key background (default: TFT_YELLOW)
   - keyTextColor: Text color on keys (default: TFT_BLACK)
   - bgScreenColor: Screen background color (default: TFT_BLACK)

5. KEYBOARD LAYOUT:
   Row 1: Q W E R T Y U I O P (10 keys)
   Row 2: 123 A S D F G H J K L (10 keys)
   Row 3: ic Z X C V B N M |e < (10 keys)
   Row 4: Space key (centered, width = 8 keys)

6. KEYBOARD MODES:
   - Alphabet mode: Letters and special keys (123, ic, |e, <)
   - Numeric mode: Numbers and special characters (ABC, /, :, ;, etc.)
   - Switch between modes by selecting "123" or "ABC" keys

7. CURSOR MANAGEMENT:
   - Cursor position: cursorRow (0-3), cursorCol (0-9)
   - Selected key highlighted with keySelectedColor
   - Cursor wraps around edges (left-right, up-down)

8. IMPLEMENTATION DETAILS:
   - Class-based design (Keyboard class)
   - Uses TFT_eSprite for rendering
   - All colors and text size are configurable
   - Optimized for 128x128 display resolution

=== WIFI PASSWORD SCREEN IMPLEMENTATION ===

1. OVERVIEW:
   - WiFi password input screen with integrated virtual keyboard
   - Displays title, password input box, and keyboard
   - Password always displayed in plain text (no asterisk hiding)
   - Allows users to directly set password string
   - Arcade-style visual design with neon colors

2. SCREEN LAYOUT:
   - Title: "WiFi Password" at position Y=5
   - Input Box: 
     * Position Y=20, Height=18px, Width=120px (centered on screen)
     * Arcade-style design with double border (cyan neon)
     * Black background, cyan border, green neon text
     * Displays placeholder "Enter pwd..." when empty
     * Text display: Shows password minus last character to prevent overflow
   - Keyboard: Drawn below (Y=80) using Keyboard class

3. PASSWORD MANAGEMENT:
   - Password stored in String password
   - Password always displayed in plain text (no hiding feature)
   - Maximum length: 20 characters (configurable)
   - Display optimization: Shows password minus last character to prevent text overflow
   - Methods:
     * getPassword() - Get current password
     * setPassword(String pwd) - Set entire password
     * appendPassword(String str) - Append string to end
     * clearPassword() - Clear password

4. KEY HANDLING:
   - handleKeyPress(String key) - Handles key press events:
     * Regular keys: Add to password (if not at max length)
     * Delete ("<"): Remove last character
     * Space (" "): Add space character
     * Enter ("|e"): Can be used for submit (not yet implemented)
     * Ignored: "123", "ABC", "ic" (mode switching keys)

5. DRAWING PROCESS:
   - draw() - Draws entire screen:
     1. Fill screen background (bgColor)
     2. Draw title (drawTitle)
     3. Draw input box with double border (arcade style)
     4. Draw password text in box (drawPassword)
     5. Draw keyboard (keyboard->draw())
     6. Redraw bottom border after keyboard to ensure visibility
     7. Push sprite to display
   - Automatically redraws when password changes

6. COLOR SYSTEM - ARCADE STYLE (All customizable):
   - bgColor: Screen background (default: TFT_BLACK)
   - titleColor: Title color (default: TFT_YELLOW - neon yellow)
   - inputBoxBgColor: Input box background (default: TFT_BLACK - arcade style)
   - inputBoxBorderColor: Input box border (default: TFT_CYAN - neon cyan)
   - textColor: Text color in input box (default: TFT_GREEN - neon green)
   - Placeholder color: Light grey (0x5AEB in RGB565)
   - Border style: Double border (2px thick) for arcade aesthetic

7. INTEGRATION WITH KEYBOARD:
   - Uses callback mechanism:
     * Keyboard has onKeySelected callback
     * When "select" is pressed on keyboard → callback is invoked
     * Callback calls wifiScreen->handleKeyPress(key)
   - Setup in main.cpp:
     * keyboard->setOnKeySelectedCallback(onKeyboardKeySelected)
     * onKeyboardKeySelected() calls wifiScreen->handleKeyPress()

8. USAGE EXAMPLE:
   ```cpp
   // Khởi tạo
   Keyboard* keyboard = new Keyboard(&sprite);
   WiFiPasswordScreen* wifiScreen = new WiFiPasswordScreen(&sprite, keyboard);
   keyboard->setOnKeySelectedCallback(onKeyboardKeySelected);
   
   // Vẽ màn hình
   wifiScreen->draw();
   
   // Set password trực tiếp
   wifiScreen->setPassword("MyPassword123");
   wifiScreen->draw();
   
   // Thêm string
   wifiScreen->appendPassword("456");
   wifiScreen->draw();
   
   // Lấy password
   String pwd = wifiScreen->getPassword();
   ```

9. IMPLEMENTATION DETAILS:
   - Class: WiFiPasswordScreen
   - Files: wifi_password.h, wifi_password.cpp
   - Dependencies: TFT_eSPI, Keyboard class
   - Uses TFT_eSprite for rendering
   - All colors and dimensions are configurable
   - Optimized for 128x128 display resolution
   - Arcade-style visual design with neon colors
   - Input box: 18px height (increased from 15px) to prevent text clipping
   - Border rendering: Double border (2px) drawn with drawFastHLine/VLine for precision
   - Text positioning: textY = inputBoxY + 7 for better vertical centering

=== WIFI LIST SCREEN IMPLEMENTATION ===

1. OVERVIEW:
   - Screen displays top 5 strongest WiFi networks
   - Arcade-style design with rounded corners
   - No borders, clean look
   - Centered WiFi names
   - Selected item highlighted with cyan background and yellow text

2. SCREEN LAYOUT:
   - Title: "WiFi Networks" at position Y=5 (neon yellow)
   - List items: Start at Y=20, each item height=18px
   - Item width: 100px (centered, with 3px rounded corners)
   - Maximum 5 items displayed
   - Item spacing: 2px between items

3. WIFI SCANNING:
   - scanNetworks() - Scans available WiFi networks
   - Sorts by RSSI (signal strength) - strongest first
   - Only displays top 5 networks
   - Uses ESP32 WiFi library

4. DISPLAY FEATURES:
   - No borders on items (clean arcade look)
   - Rounded corners (3px radius) using fillRoundRect
   - Selected item: Cyan background (TFT_CYAN) with yellow text (TFT_YELLOW)
   - Unselected items: Black background with green text (TFT_GREEN)
   - Centered text in items
   - Text truncation: Max 15 characters per SSID

5. NAVIGATION:
   - selectNext() - Move to next WiFi
   - selectPrevious() - Move to previous WiFi
   - selectIndex(uint8_t index) - Select by index
   - Wraps around (circular navigation)

6. COLOR SYSTEM - ARCADE STYLE:
   - bgColor: Screen background (default: TFT_BLACK)
   - titleColor: Title color (default: TFT_YELLOW - neon yellow)
   - itemBgColor: Unselected item background (default: TFT_BLACK)
   - itemSelectedBgColor: Selected item background (default: TFT_CYAN - neon cyan)
   - itemTextColor: Unselected item text (default: TFT_GREEN - neon green)
   - itemSelectedTextColor: Selected item text (default: TFT_YELLOW - neon yellow)
   - All colors are customizable via setter methods

7. IMPLEMENTATION DETAILS:
   - Class: WiFiListScreen
   - Files: wifi_list.h, wifi_list.cpp
   - Dependencies: TFT_eSPI, WiFi library
   - Uses TFT_eSprite for rendering
   - Optimized for 128x128 display resolution
   - Rounded corners using fillRoundRect

=== WIFI MANAGER IMPLEMENTATION ===

1. OVERVIEW:
   - Manages complete WiFi connection flow
   - State machine-based design
   - Integrates WiFiListScreen and WiFiPasswordScreen
   - Handles automatic WiFi selection and connection
   - Auto-fills password for specific networks (e.g., "Van Ninh" with "123456a@")

2. STATE MACHINE:
   - WIFI_STATE_SCAN: Scanning for WiFi networks
   - WIFI_STATE_SELECT: Selecting WiFi from list
   - WIFI_STATE_PASSWORD: Entering password
   - WIFI_STATE_CONNECTING: Attempting connection
   - WIFI_STATE_CONNECTED: Successfully connected
   - WIFI_STATE_ERROR: Connection failed/timeout

3. FLOW EXAMPLE - "Van Ninh" WiFi:
   1. Scan networks → Auto-find "Van Ninh" if available
   2. Auto-select "Van Ninh" → Move to password screen
   3. Auto-fill password "123456a@"
   4. User presses Enter (|e) → Start connecting
   5. Show "Connecting..." message
   6. On success → Show "Connected!" with SSID
   7. On failure → Show "Connection failed!" after 10s timeout

4. METHODS:
   - begin() - Initialize and start scanning (auto-finds "Van Ninh")
   - update() - Update state machine (call in loop)
   - handleUp() - Navigate up in WiFi list
   - handleDown() - Navigate down in WiFi list
   - handleSelect() - Select current WiFi
   - handleKeyboardInput(String key) - Handle keyboard input in password screen
   - getState() - Get current state
   - isConnected() - Check if connected
   - getConnectedSSID() - Get connected WiFi name
   - getPasswordScreen() - Get WiFiPasswordScreen instance
   - getListScreen() - Get WiFiListScreen instance
   - disconnect() - Disconnect from WiFi

5. AUTO-FEATURES:
   - Auto-find "Van Ninh" in scan results during begin()
   - Auto-select if found
   - Auto-fill password "123456a@" for "Van Ninh"
   - Automatic connection when Enter is pressed

6. CONNECTION HANDLING:
   - Uses WiFi.begin(ssid, password)
   - 10-second timeout
   - Shows status messages on screen (Connecting/Connected/Error)
   - Handles connection errors gracefully

7. INTEGRATION:
   - Manages WiFiListScreen instance
   - Manages WiFiPasswordScreen instance
   - Integrates with Keyboard for password input
   - Uses callback mechanism for keyboard events

8. USAGE EXAMPLE:
   ```cpp
   // Initialize
   WiFiManager* wifiManager = new WiFiManager(&sprite, keyboard);
   wifiManager->begin();  // Auto-scans and finds "Van Ninh"
   
   // In loop
   wifiManager->update();  // Update state machine
   
   // Navigation (from buttons/joystick)
   wifiManager->handleUp();
   wifiManager->handleDown();
   wifiManager->handleSelect();
   
   // Check status
   if (wifiManager->isConnected()) {
       String ssid = wifiManager->getConnectedSSID();
   }
   ```

9. IMPLEMENTATION DETAILS:
   - Class: WiFiManager
   - Files: wifi_manager.h, wifi_manager.cpp
   - Dependencies: TFT_eSPI, WiFi library, WiFiListScreen, WiFiPasswordScreen, Keyboard
   - State machine pattern
   - Automatic flow for known networks ("Van Ninh" → "123456a@")
   - Error handling and timeout management
   - Clean separation of concerns

